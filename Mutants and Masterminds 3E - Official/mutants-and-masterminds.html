<input class="sheet-hide-output" type="checkbox" name="attr_hide-output" value="1" checked="true" /><span></span>
<input class="sheet-output-message" type="text" name="attr_output-message" title="output-message" />
<div class="sheet-wrapper">
<div class="sheet-row">

    <!-- Logo -->
    

    <!-- --------------- -->
    <!-- Details Section -->
    <!-- --------------- -->
    <div class="section-details">
		<div class="character">
			<input type="text" name="attr_identity-name" title="identity-name" placeholder="Real Identity"/>
			<input type="text" name="attr_character_name" title="real-name" placeholder="Super Alias"/>
			
			
		</div>
		<div class="details1">
			<b> Secret</b><input type="radio" name="attr_identity-status" title="identity-status" value="0"/>
			<b>Gender:</b><input type="text" name="attr_gender" title="gender" value=""/>
			<b>Height:</b><input type="text" name="attr_height" title="height"/>
			<b>Weight:</b><input type="text" name="attr_weight" title="weight"/>
			<b> Public</b><input type="radio" name="attr_identity-status" title="identity-status" value="1"/>
			<b>Age:</b><input type="number" name="attr_age" title="age" value="0"/>
			<b>Eyes:</b><input type="text" name="attr_eyes" title="eyes"/>
			<b>Hair:</b><input type="text" name="attr_hair" title="hair"/>

			
			

		</div>
		<div class="details2">
			<div>
				<input type="text" name="attr_group" title="group" placeholder="Group Affiliation" />
				<input type="text" name="attr_base" title="base" placeholder="Base of Operations" />
			</div>
			<div>
				<input type="number" name="attr_power-level" title="power-level" value="0" placeholder="Power Lever"/>
				<span>Â¢</span>
			</div>
		</div>
		<div class="power">
			<b>Power Point Totals:</b>
			<b>Abilities</b><input type="number" name="attr_ability-points" title="ability-points" value="(@{total-ability-score} * 2)" disabled/>
			<b>+</b>
			<b>Powers</b><input type="number" name="attr_power-points" title="power-points" value="0"/><b>+</b>
			<b>Advantages</b><input type="number" name="attr_advantage-points" title="advantage-points" value="0"/>
			<b>+</b>
			<b>Skills</b><input type="number" name="attr_skill-points" title="skill-points" value="(@{total-skill-ranks} / 2)" disabled/>
			<b>+</b>
			<b>Defenses</b>
			<input type="number" name="attr_defense-points" title="defense-points" value="@{total-defense-points}" disabled/>
			<b>=</b>
			<input type="number" name="attr_total-power-points" title="attr_total-power-points" value="(@{ability-points} + @{power-points} + @{advantage-points} + @{skill-points} + @{defense-points})" disabled/><b>/</b>
			<input type="number" name="attr_max-power-points" title="attr_max-power-points" value="(@{starting-power-points} + @{power-points-earned})" disabled/><b> *</b>
		</div>
		<img src="https://i.imgur.com/0aRNO0Z.png" title="Mutants and Masterminds Character Sheet"/>
	</div>
</div>
<span class="note"><b>* Total Power Points Earned = Starting Power Points + Power Points Earned</b></span>
<br />

<input type="hidden" name="attr_tab" class="tab" value="stats"/>
<button class="tab-button" type="action" name="act_details">Details</button>
<button class="tab-button" type="action" name="act_stats">Stats & Skills</button>
<button class="tab-button" type="action" name="act_powers">Powers, Advantages, & Equipment</button>
<button class="tab-button" type="action" name="act_options">Options</button>
 
<!-- ------------------------------------- -->
<!--       Page 1 (BIO)                    -->
<!-- ------------------------------------- -->
<div class="sheet-tab-content sheet-tab1">
    <div class="body">
        <div class="section-notes">
            <div class="textbox">
                <span class="label">BIOGRAPHY</span>
                <textarea name="details_biography" style="min-height: 300px; height: 300px;"></textarea>
            </div>
            <div class="textbox">
                <span class="label">COMPLICATIONS</span>
                <textarea name="details_complications" style="min-height: 300px; height: 300px;"></textarea>
            </div>
            <div class="textbox">
                <span class="label">MOTIVATIONS</span>
                <textarea name="details_motivations" style="min-height: 300px; height: 300px;"></textarea>
                
            </div>
        </div>
    </div>    
</div>


<!-- ------------------------------------- -->
<!--       Page 1 (Stats & Skills)         -->
<!-- ------------------------------------- -->
<div class="sheet-tab-content sheet-tab2">
    <div class="sheet-2colrow">
    </div>
            
</div>

<!-- ---------------------------------- -->
<!-- Page 2 (Powers, Advantages & Gear) -->
<!-- ---------------------------------- -->
<div class="sheet-tab-content sheet-tab3">
    <input type="hidden" name="attr_subtab" class="tab" value="all"/>
    <button type="action" name="act_all">All</button>
    <button type="action" name="act_devices">Powers & Devices</button>
    <button type="action" name="act_advantages">Advantages</button>
    <button type="action" name="act_equipment">Equipment</button>
    
    
</div>

<!-- --------------------------------- -->
<!--         Page 3 (Options)          -->
<!-- --------------------------------- -->
<div class="sheet-tab-content sheet-tab4">
	
</div>

<div class="sheet-mnm-footer">
	<img src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/Mutants%20and%20Masterminds%203E/logo_powered.png" class="sheet-mnm-logo">
</div>
</div>

<script type="text/worker">

    ["details", "stats", "powers", "options"].forEach((button) => {
        on(`clicked:${button}`, (eventinfo) => {
            setAttrs({ tab: button });
        });
    });

    ["devices", "advantages", "equipment", "all"].forEach((button) => {
        on(`clicked:${button}`, (eventinfo) => {
            setAttrs({ subtab: button });
        });
    });


    function clearLog() {
        setAttrs({"output-message": "", "hide-output": "1"}, {silent: true});
    }
    
    function log(value) {
        setAttrs({"output-message": value, "hide-output": "0"}, {silent: true});
        console.log(value);
    };
    
    function pluralize(count, thing, singular, plural) {
        if(!singular) {
            singular = "";
        }
        if(!plural) {
            plural = "s";
        }
        
        return count + " " + thing
            + (count == 1 ? singular : plural);
    }
    
    try {
        var equipmentRowID = null;
        
        /**
         * @param repeatingName - The word that comes after "repeating_" in the
         * attribute name. For instance, if you want to find
         * "repeating_equipment_$0_name", then this should be "equipment".
         * 
         * @param suffixes - An array of words identifying which parts of the
         * repeating attribute you want. For instance, if you want
         * "repeating_equipment_$0_name" and "repeating_equipment_$0_description",
         * then this should be ["name", "description"].
         * 
         * @param callback - A function that takes an array of objects. This
         * will be called once the attributes have been found. Each object in
         * the array will contain a property for each string in suffixes, mapped
         * to the value of that attribute. The objects won't be in order, but
         * they will include the repeating section id. If you passed the values
         * mentioned above, then this might return the following array:
         * [
         *     {id:"ABC", name:"Sword", description:""},
         *     {id:"DEF", name:"Shield", description:"A simple wooden buckler."}
         * ]
         */
        function getRepeatingAttributes(repeatingName, suffixes, callback) {
            getSectionIDs("repeating_" + repeatingName, function(idArray) {
                var attributeNames = [];
                for(var suffix of suffixes) {
                    for(var id of idArray) {
                        attributeNames.push("repeating_" + repeatingName
                            + "_" + id + "_" + suffix);
                    }
                }
                
                getAttrs(attributeNames, function(attributes) {
                    var result = [];
                    for(var id of idArray) {
                        var attributeSection = {id:id};
                        result.push(attributeSection);
                        
                        for(var suffix of suffixes) {
                            attributeSection[suffix] = attributes["repeating_"
                                + repeatingName + "_" + id + "_" + suffix];
                        }
                    }
                    
                    callback(result);
                });
            });
        }
        /**
         * Like getRepeatingAttributes, but puts the array in order.
         */
        function getRepeatingAttributesOrdered(repeatingName, suffixes, callback) {
            getRepeatingAttributes(repeatingName, suffixes, function(attributes) {
                getSectionIDsOrdered(repeatingName, function(idsOrdered) {
                    var result = [];
                    
                    for(var id of idsOrdered) {
                        for(var attribute of attributes) {
                            if(attribute.id === id) {
                                result.push(attribute);
                                break;
                            }
                        }
                    }
                    
                    callback(result);
                });
            }, true);
        }
        
        function recountAll() {
            console.log("Recounting everything:");
            recountPowers(true);
            recountAdvantages(recountEquipment);
        }
        
        /**
         * @param calculateCost - Set this to true if all powers should be
         * calculated, or to a row ID if you only want to recalculate one. Make
         * sure to convert the row ID to lowercase if it isn't already (this
         * will happen automatically if you extract it from eventInfo).
         */
        function recountPowers(calculateCost, doneCallback) {
            var suffixes;
            if(calculateCost) {
                suffixes = ["ranks", "points-per-rank", "misc-points", "total-cost",
                    "alternate-effect"];
            } else {
                suffixes = ["total-cost"];
            }
            
            getRepeatingAttributesOrdered("power", suffixes, function(powers) {
                var total = 0;
                for(var power of powers) {
                    if(calculateCost === true || calculateCost === power.id.toLowerCase()) {
                        power["total-cost"] = calculatePowerCost(powers, power);
                    }
                    total += parseInt(power["total-cost"]);
                }
                setAttrs({"power-points": total}, {silent: true});
                console.log("Spent " + pluralize(total, "point") + " on powers.");
                
                if(doneCallback) {
                    doneCallback();
                }
            });
        }
        
        /**
         * Given a complete array of ordered powers and one entry out of that
         * array, calculates the total cost of that power. This updates the
         * attribute (asynchronously), and also updates the power object
         * in-place.
         */
        function calculatePowerCost(orderedPowers, power) {
            var total = parseInt(power.ranks) * parseFloat(power["points-per-rank"])
                + parseInt(power["misc-points"]);
            
            //If this is an alternate effect, find the effect it's based
            //on and make sure this is cheaper (or the same price).
            if(power["alternate-effect"] === "1" || power["alternate-effect"] === "2") {
                var index = orderedPowers.indexOf(power);
                if(index < 0) {
                    return parseInt(power["total-cost"]);
                } else if(index == 0) {
                    log("Your first power can't be an alternate effect. Try rearranging your powers.");
                    let values = {};
                    values["repeating_power_" + power.id + "_alternate-effect"] = "0";
                    setAttrs(values, {silent: true});
                    return parseInt(power["total-cost"]);
                }
                
                for(var i = index - 1; i >= 0; i--) {
                    let effectStatus = orderedPowers[i]["alternate-effect"];
                    if(effectStatus !== "1" && effectStatus !== "2") {
                        //Check the cost.
                        if(total > parseInt(orderedPowers[i]["total-cost"])) {
                            log("An alternate effect can't cost more than the primary effect. (Current cost: "
                                + total + ", maximum allowed cost: " + orderedPowers[i]["total-cost"] + ".)");
                            break;
                        } else {
                            //Success!
                            let values = {};
                            values["repeating_power_" + power.id + "_total-cost"] =
                                power["total-cost"] = power["alternate-effect"];
                            setAttrs(values, {silent: true});
                            return parseInt(power["total-cost"]);
                        }
                    } else if(i == 0) {
                        log("Your first power can't be an alternate effect. Try rearranging your powers.");
                    }
                }
                
                //If none was found or if the cost was wrong,
                //then this isn't a valid alternate effect.
                let values = {};
                values["repeating_power_" + power.id + "_alternate-effect"] = "0";
                setAttrs(values, {silent: true});
            }
            
            let values = {};
            values["repeating_power_" + power.id + "_total-cost"] = "" + Math.ceil(total);
            setAttrs(values, {silent: true});
            
            console.log("Power " + orderedPowers.indexOf(power) + " costs " + Math.ceil(total));
            
            return Math.ceil(total);
        }
        
        function recountAdvantages(doneCallback) {
            getAttrs(["Wealth"], function(dict) {
                var wealth = 8;
                if(dict["Wealth"]) {
                    wealth = parseInt(dict["Wealth"]);
                }
                if(!wealth || wealth < 0) {
                    wealth = 0;
                    setAttrs({Wealth:0});
                }
                
                getRepeatingAttributes("advantage", ["name", "ranks"], function(advantages) {
                    var total = Math.ceil(wealth / 4) - 2;
                    equipmentRowID = null;
                    
                    for(var advantage of advantages) {
                        total += parseInt(advantage.ranks);
                        
                        if(advantage.name && advantage.name.toLowerCase() === "equipment") {
                            equipmentRowID = advantage.id;
                            
                            var ranks = parseInt(advantage.ranks);
                            if(ranks) {
                                setAttrs({"equipment-points":ranks * 5}, {silent: true});
                            } else {
                                setAttrs({"equipment-points":5}, {silent: true});
                            }
                        }
                    }
                    
                    setAttrs({"advantage-points": total}, {silent: true});
                    
                    console.log("Spent " + pluralize(total, "point") + " on advantages.");
                    
                    if(doneCallback) {
                        doneCallback();
                    }
                });
            });
        }
        
        function recountEquipment(doneCallback) {
            getRepeatingAttributes("equipment", ["cost"], function(equipment) {
                var total = 0;
                
                for(var e of equipment) {
                    total += parseInt(e.cost);
                }
                
                getAttrs(["equipment-points"], function(attr) {
                    var maximum = 0;
                    if(attr["equipment-points"]) {
                        maximum = parseInt(attr["equipment-points"]);
                    }
                    
                    if(total > maximum) {
                        var ranks = Math.ceil(total / 5);
                        log("Buying " + pluralize(total, "point") + " of equipment requires "
                            + pluralize(ranks, "rank") + " of the Equipment advantage.");
                    } else {
                        getAttrs(["output-message"], function(dict) {
                            if(dict["output-message"].endsWith(" of the Equipment advantage.")) {
                                clearLog();
                            }
                        });
                    }
                    
                    if(doneCallback) {
                        doneCallback();
                    }
                });
            });
        }
        
        on("sheet:opened", function() {
            clearLog();
            
            getAttrs(["equipment-points"], function(attr) {
                if(!attr["equipment-points"]) {
                    recountAll();
                } else {
                    getRepeatingAttributes("advantage", ["name"], function(advantages) {
                        for(var advantage of advantages) {
                            if(advantage.name.toLowerCase() === "equipment") {
                                equipmentRowID = advantage.id;
                                break;
                            }
                        }
                    });
                }
            });
        });
        
        function getSectionIDsOrdered(sectionName, callback) {
            'use strict';
            getAttrs([`_reporder_repeating_${sectionName}`], function(v) {
                getSectionIDs(sectionName, function(idArray) {
                    let reporderArray = v[`_reporder_repeating_${sectionName}`]
                        ? v[`_reporder_repeating_${sectionName}`].toLowerCase().split(',') : [],
                    ids = [...new Set(reporderArray.filter(x => idArray.includes(x)).concat(idArray))];
                    callback(ids);
                });
            });
        }
        
        on("change:repeating_power:name", function(eventInfo) {
            if(eventInfo.sourceType !== "sheetworker"
                //These values are only ever equal when the attribute is first set.
                && eventInfo.newValue == eventInfo.previousValue) {
                var rowID = eventInfo.sourceAttribute.substr("repeating_power_".length, 20);
                recountPowers(rowID);
            }
        });
        on("change:repeating_power:ranks change:repeating_power:points-per-rank "
                + "change:repeating_power:misc-points change:repeating_power:alternate-effect", function(eventInfo) {
            if(eventInfo.sourceType !== "sheetworker") {
                var rowID = eventInfo.sourceAttribute.substr("repeating_power_".length, 20);
                recountPowers(rowID);
            }
        });
        on("change:repeating_power:total-cost remove:repeating_power", function(eventInfo) {
            if(eventInfo.sourceType !== "sheetworker") {
                recountPowers();
            }
        });
        
        on("change:repeating_advantage:ranks", function(eventInfo) {
            if(eventInfo.sourceType !== "sheetworker") {
                if(eventInfo.sourceAttribute.toLowerCase().indexOf(equipmentRowID) >= 0) {
                    recountAdvantages(recountEquipment);
                } else {
                    recountAdvantages();
                }
            }
        });
        on("change:repeating_advantage:name", function(eventInfo) {
            if(eventInfo.previousValue.toLowerCase() === "equipment") {
                setAttrs({"equipment-points":0}, function() {
                    recountAdvantages(recountEquipment);
                });
            } else if(eventInfo.newValue.toLowerCase() === "equipment"
                || eventInfo.sourceType !== "sheetworker"
                && eventInfo.newValue == eventInfo.previousValue) {
                recountAdvantages(recountEquipment);
            }
        });
        on("remove:repeating_advantage", function(eventInfo) {
            if(eventInfo.sourceAttribute.toLowerCase().indexOf(equipmentRowID) >= 0) {
                setAttrs({"equipment-points":0}, function() {
                    recountAdvantages(recountEquipment);
                });
            } else {
                recountAdvantages();
            }
        });
        
        on("change:Wealth", function(eventInfo) {
            if(eventInfo.sourceType !== "sheetworker") {
                if(eventInfo.newValue !== undefined) {
                    onGotNewValue({Wealth:eventInfo.newValue});
                } else {
                    getAttrs(["Wealth"], onGotNewValue);
                }
                
                function onGotNewValue(data) {
                    var wealth = parseInt(data["Wealth"]);
                    
                    var description;
                    if(wealth <= 0) {
                        description = "Impoverished";
                    } else if(wealth <= 4) {
                        description = "Struggling";
                    } else if(wealth <= 10) {
                        description = "Middle Class";
                    } else if(wealth <= 15) {
                        description = "Affluent";
                    } else if(wealth <= 20) {
                        description = "Wealthy";
                    } else if(wealth <= 30) {
                        description = "Rich";
                    } else {
                        description = "Filthy Rich";
                    }
                    
                    setAttrs({"wealth-description": description}, {silent: true});
                    
                    recountAll();
                }
            }
        });
        
        
        on("change:repeating_equipment:name", function(eventInfo) {
            if(eventInfo.sourceType !== "sheetworker"
                && eventInfo.newValue == eventInfo.previousValue) {
                recountEquipment();
            }
        });
        on("change:repeating_equipment:cost remove:repeating_equipment", function(eventInfo) {
            if(eventInfo.sourceType !== "sheetworker") {
                recountEquipment();
            }
        });
        
        on("change:output-message", function(eventInfo) {
            if(eventInfo.sourceType !== "sheetworker") {
                clearLog();
            }
        });
    } catch(e) {
        log("Encountered an error: " + e);
    }
</script>

